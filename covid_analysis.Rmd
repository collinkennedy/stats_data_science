---
title: "covid_analysis"
author: "Collin"
date: "5/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(caret)
library(tidyverse)
library(readxl)
library(forecast)

library(plotly)
library(httr)
library(rvest)
library(ggpubr)


#merge by state
#from nyt

us_counties <- read_csv("us-counties.csv")
us_counties
# us_counties = us_counties %>% 
#   group_by(county) %>% 
#   mutate(daily_deaths = deaths - lag(deaths,1)) %>% 
#   rename("total_deaths" = "deaths")




#from cdc- merge nyt and cdc
cdc_vaccinations <-read_csv("Vaccine_Hesitancy_for_COVID-19__County_and_local_estimates.csv")
cdc_vaccinations = cdc_vaccinations %>% rename("fips" = `FIPS Code`)
cdc_vaccinations %>% head(10)



counties_vaccination_df = us_counties %>% mutate(fips = as.double(fips)) %>% left_join(cdc_vaccinations,by = "fips")

#THE dataframe to use for analysis
counties_vaccination_df = counties_vaccination_df %>% 
  group_by(state,county) %>% 
  mutate(daily_deaths = deaths - lag(deaths)) %>% 
  rename("total_deaths" = "deaths") %>% drop_na(daily_deaths)

```



#TEST
```{r}
counties_vaccination_df

#TEST TEST TEST
#test case should be 64 total deaths in Bibb County, Alabama
counties_vaccination_df %>% filter(state == "Alabama") %>% 
  filter(county == "Bibb") %>% select(county,total_deaths,daily_deaths) %>% drop_na(daily_deaths) %>% 
  summarize(total_daily_deaths = sum(daily_deaths))

vector1 = c(0,0,0,1,1,2,3,4)
vector2 = vector1 - lag(vector1)
vector2
```


```{r}
#attempt at whole US to get an idea of the overall picture


#how many counties are there? 1930
counties_vaccination_df %>% group_by(county) %>% 
  summarize(number_of_counties = n_distinct(county)) %>% arrange(desc(number_of_counties))
#55 states (includes territories like Guam)



#This should verify the data is correct
sum_daily_deaths = counties_vaccination_df %>% drop_na(daily_deaths) %>% 
  group_by(state,county) %>% filter(county != "Unknown") %>% 
  summarize(sum_daily_deaths = sum(daily_deaths))
sum_daily_deaths %>% filter(sum_daily_deaths < 0)



```






## Plot of daily deaths in the 50 states
```{r}
#make data

counties_vaccination_df %>% filter(state == "Washington")
str(counties_vaccination_df$state)

#make 50 different graphs
plot_vector = c()
for(st in unique(counties_vaccination_df$state)){
  plot_data = counties_vaccination_df %>% select(date,daily_deaths,state) %>% 
    filter(state == st) %>% 
    filter(daily_deaths >= 0) 
    
    covid_plot = ggplot(data = plot_data,mapping = aes(x = date, y = daily_deaths, color = state))+
      geom_line()
    plot_vector = c(plot_vector,covid_plot)
    
  
  
}
str(plot_vector)
ggarrange(plot_vector, ncol = 5)
```


```{r}
#initialize data
mm_data = read_csv("mask_mandate.csv")
mm_data %>% head(50)
death_data = read_csv("covid_deaths_by_county.csv")
death_data %>% head(50)

View(mm_data)


death_data = death_data %>% 
  rename("covid_deaths" = `Deaths involving COVID-19`) %>% 
   drop_na(covid_deaths) %>%
  select(-Footnote)

print(death_data)

#merge death and mm_data based on 

mm_death_data = full_join(mm_data,death_data)

mm_death_data %>% head(50)
View(mm_death_data)
death_data


mm_death_data
```


```{r}
#group data by county name, display when No Mask Mandate
mm_death_data %>% filter(Current_order_status == "No Public Mask Mandate") %>% 
  group_by(State_Tribe_Territory,County_Name) %>% 
  arrange(desc(date)) %>% 
  slice(c(1,n())) %>% select(State_Tribe_Territory,County_Name,FIPS_State,date,order_code,FIPS_County) %>% 
  full_join(death_data) %>% filter(covid_deaths != NA)


```




```{r}

#IGNORE
html = read_html("https://data.cdc.gov/NCHS/Provisional-COVID-19-Death-Counts-in-the-United-St/kn79-hsxy")

stuff = xml2::read_html("https://data.cdc.gov/NCHS/Provisional-COVID-19-Death-Counts-in-the-United-St/kn79-hsxy")
library(rvest)
library(xml2)
ca_counties = read_html("https://www.nytimes.com/interactive/2021/us/california-covid-cases.html") %>% 
  html_node("table.g-table.super-table.withchildren") %>% html_table()
ca_counties

?html_nodes
```





```{r}


```

