---
title: "covid_analysis"
author: "Collin"
date: "5/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(caret)
library(tidyverse)
library(readxl)
library(forecast)

library(plotly)
library(httr)
library(rvest)
library(ggpubr)
library(quantmod)
# library(Hmisc)
# library(lfe)
# library(AER)
# library(forecast)
# library(astsa)
# library(aTSA)


#merge by state
#from nyt

us_counties <- read_csv("us-counties.csv")
us_counties
# us_counties = us_counties %>% 
#   group_by(county) %>% 
#   mutate(daily_deaths = deaths - lag(deaths,1)) %>% 
#   rename("total_deaths" = "deaths")




#from cdc- merge nyt and cdc
cdc_vaccinations <-read_csv("Vaccine_Hesitancy_for_COVID-19__County_and_local_estimates.csv")
cdc_vaccinations = cdc_vaccinations %>% rename("fips" = `FIPS Code`)
cdc_vaccinations %>% head(10)



counties_vaccination_df = us_counties %>% mutate(fips = as.double(fips)) %>% left_join(cdc_vaccinations,by = "fips")

#THE dataframe to use for analysis
counties_vaccination_df = counties_vaccination_df %>% 
  group_by(state,county) %>% filter(county != "Unknown") %>% 
  mutate(daily_deaths = deaths - lag(deaths)) %>% 
  mutate(date = as.Date(date)) %>% 
  rename("total_deaths" = "deaths") %>% drop_na(daily_deaths)


counties_vaccination_df %>% arrange(date) %>% head(5)

counties_vaccination_df %>% drop_na(daily_deaths) %>% 
  group_by(state,county) %>% 
  dplyr::summarize(total_daily_deaths = sum(daily_deaths))
  
  
  
```


#TEST
```{r}
#TEST TEST TEST
#test case should be 64 total deaths in Bibb County, Alabama
counties_vaccination_df %>% filter(state == "Alabama") %>% 
  filter(county == "Bibb") %>% select(county,total_deaths,daily_deaths) %>% drop_na(daily_deaths) %>% 
  dplyr::summarize(summed_daily_deaths = sum(daily_deaths))

vector1 = c(0,0,0,1,1,2,3,4)
vector2 = vector1 - lag(vector1)
vector2
```


# Time Series
```{r}
## Time series stuff

?forecast::accuracy() #potentially use this to evaluate accuracy of our model when we validate the model on test data
?ARMAacf
?arima #fits an arima model to a time series object
?arima.sim #simulates an arima model where you choose the parameters for ar and ma
?ARMAtoMA #converts an ARMA to an infinite MA process (by property of invertibility)
?sarima #fit a arima(p,d,q) with an xreg argument to provide other regressors
?arima


#establish time series object for daily deaths
?

counties_vaccination_df$L.daily_deaths <- Lag(counties_vaccination_df$daily_deaths, 1)
counties_vaccination_df$L2.daily_deaths <- Lag(counties_vaccination_df$daily_deaths, 2)
counties_vaccination_df$L3.daily_deaths <- Lag(counties_vaccination_df$daily_deaths, 3)

auto.arima(counties_vaccination_df$daily_deaths)
?auto.arima

difference1 <- counties_vaccination_df$daily_deaths - counties_vaccination_df$L.daily_deaths
difference2 <- counties_vaccination_df$L.daily_deaths - counties_vaccination_df$L2.daily_deaths
difference3 <- counties_vaccination_df$L2.daily_deaths - counties_vaccination_df$L3.daily_deaths

auto.arima(difference1)

death_model <- lm(data = counties_vaccination_df, difference1 ~ difference2 + difference3 + counties_vaccination_df$`Percent adults fully vaccinated against COVID-19` + counties_vaccination_df$`Estimated hesitant`)
summary(death_model)

#ARMA(2,1)
## Calls it an ARIMA(2,1,1 Process)
```



## Checking Stationarity Assumptions for each State
```{r}
#create a time series object for each state and check if its stationary 


states = unique(counties_vaccination_df$state)

# out = adf.test(daily_deaths_ts)
# unname(out$type1[1,3]) #loop over the row but keep 3rd column because thats the p-value
# str(out$type1)
# 
# str(out$type1[1,3])

#create empty dataframe
stationary_df = tibble(state = states, stationary_status = rep("stationary",length(states)) )
stationary_df

#LOOP TO DETERMINE WHICH STATES HAVE NON STATIONARY TIME SERIES
for(place in states){ 
  daily_deaths_ts = ts((counties_vaccination_df %>% filter(state== place))$daily_deaths, frequency = 1) #first create a ts object
  adf_out = adf.test(daily_deaths_ts) #conduct the augmented-dickey fuller test for stationarity on the time series object
  for(i in length(adf_out$type1[,3])){ #now loop through each lag of the adf.test output. if find a p-value > .05, conclude not stationary 
    if(unname(adf_out$type1[i,3]) > .05){
      stationary_df = stationary_df %>% mutate(stationary_status = case_when(
        state == place ~ "NOT STATIONARY",
        TRUE ~ as.character(stationary_status)
      ))
      next
      
    }
  }  
}
stationary_df %>% filter(stationary_status == "NOT STATIONARY") #District of Columbia only non-stationary 

```

Suggested Model by auto.arima: 
$deaths_i = \beta_1deaths_{i-1} + \beta_2deaths_{i-2} + \alpha_1\theta_1 + \epsilon_i$ estimated by $deaths_i = .0528deaths_{i-1} + .0128deaths_{i-2} -.9862\theta_1$

other model: 
$deathdifference_i = \beta_0 + \beta_1deathdifference_{i-1} + \beta_2deathdifference_{i-2} + \beta_3fullyvaccinated_{i} + \beta_4EstimatedHesitant_i + \epsilon_i$ estimated by 

$deathdifference_i = .099 - .68deathdifference_{i-1} - .38deathdifference_{i-2} + .27fullyvaccinated_{i} - 1.54EstimatedHesitant_i$


#TEST
```{r}
counties_vaccination_df

#TEST TEST TEST
#test case should be 64 total deaths in Bibb County, Alabama
counties_vaccination_df %>% filter(state == "Alabama") %>% 
  filter(county == "Bibb") %>% select(county,total_deaths,daily_deaths) %>% drop_na(daily_deaths) %>% 
  dplyr::summarize(total_daily_deaths = sum(daily_deaths))

vector1 = c(0,0,0,1,1,2,3,4)
vector2 = vector1 - lag(vector1)
vector2
```


```{r}
#attempt at whole US to get an idea of the overall picture


#how many counties are there? 1930
counties_vaccination_df %>% group_by(county) %>% 
  summarize(number_of_counties = n_distinct(county)) %>% arrange(desc(number_of_counties))
#55 states (includes territories like Guam)



#This should verify the data is correct-> no more negatives
sum_daily_deaths = counties_vaccination_df %>% 
  group_by(state,county) %>% 
  dplyr::summarize(sum_daily_deaths = sum(daily_deaths))
sum_daily_deaths %>% filter(sum_daily_deaths < 0)



```






## Plot of daily deaths in the 50 states
```{r}
#make data

counties_vaccination_df %>% filter(state == "Washington")
str(counties_vaccination_df$state)

#make 50 different graphs
plot_vector = c()
for(st in unique(counties_vaccination_df$state)){
  plot_data = counties_vaccination_df %>% select(date,daily_deaths,state) %>% 
    filter(state == st) %>% 
    filter(daily_deaths >= 0) 
    
    covid_plot = ggplot(data = plot_data,mapping = aes(x = date, y = daily_deaths, color = state))+
      geom_line()
    plot_vector = c(plot_vector,covid_plot)
    
  
  
}
str(plot_vector)
ggarrange(plot_vector, ncol = 5)
```


```{r}
#initialize data
mm_data = read_csv("mask_mandate.csv")
mm_data %>% head(50)
death_data = read_csv("covid_deaths_by_county.csv")
death_data %>% head(50)

View(mm_data)


death_data = death_data %>% 
  rename("covid_deaths" = `Deaths involving COVID-19`) %>% 
   drop_na(covid_deaths) %>%
  select(-Footnote)

print(death_data)

#merge death and mm_data based on 

mm_death_data = full_join(mm_data,death_data)

mm_death_data %>% head(50)
View(mm_death_data)
death_data


mm_death_data
```


```{r}
#group data by county name, display when No Mask Mandate
mm_death_data %>% filter(Current_order_status == "No Public Mask Mandate") %>% 
  group_by(State_Tribe_Territory,County_Name) %>% 
  arrange(desc(date)) %>% 
  slice(c(1,n())) %>% select(State_Tribe_Territory,County_Name,FIPS_State,date,order_code,FIPS_County) %>% 
  full_join(death_data) %>% filter(covid_deaths != NA)


```




```{r}

#IGNORE
html = read_html("https://data.cdc.gov/NCHS/Provisional-COVID-19-Death-Counts-in-the-United-St/kn79-hsxy")

stuff = xml2::read_html("https://data.cdc.gov/NCHS/Provisional-COVID-19-Death-Counts-in-the-United-St/kn79-hsxy")
library(rvest)
library(xml2)
ca_counties = read_html("https://www.nytimes.com/interactive/2021/us/california-covid-cases.html") %>% 
  html_node("table.g-table.super-table.withchildren") %>% html_table()
ca_counties

?html_nodes
```





```{r}


```

